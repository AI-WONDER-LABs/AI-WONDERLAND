= CircleCI task agent CLI usage guide
:page-platform: Cloud, Server v4+
:page-description: Using the CircleCI task agent CLI in your CI/CD pipeline
:experimental:

This page provides reference documentation for the CircleCI task agent CLI. This CLI is different from the xref:local-cli.adoc[CircleCI local CLI] tool that you may already know. Understanding the difference between these two CLI interfaces is essential for effective usage during your build processes.

== CLI differentiation

The CircleCI Task Agent:: A specialized command-line interface. Task agent retrieves and configures a task before managing the execution of the job within a chosen compute environment. The Task agent CLI is available for use in your CI/CD pipelines.

The Local CLI:: The development tool used on a local machine. It handles day-to-day development tasks, testing, and local workflow management.

These tools share some similarities. However, they serve different purposes and operate in different contexts with different capabilities and permissions.

=== What you will find in this document

This reference guide covers some basic information about the CircleCI task-agent CLI, including:

* Complete command reference - available commands and subcommands.
* Flag documentation - Comprehensive flag options with descriptions.
* Usage examples - Practical examples showing real-world usage patterns.
* Command descriptions - Clear explanations of what each command does.

== Root command

=== circleci

The CLI tool to be used in CircleCI.

== Subcommands

=== Task

Manage tasks. You can also use the alias `step` instead of `task`.

==== Halt

Halt is a subcommand of `task`. This command stops the current task and treat it as successful.

*Example usage:*

.Equivalent commands to halt the current task and treat it as successful
[source,yaml]
----
## These commands would be equivalent:
circleci task halt
circleci step halt
----

=== Version

Output version information.

*Flags*

* `short`: print only the version string.

*Example usage:*

[source,yaml]
----
jobs:
  my-job
    executor: some-executor
    steps:
      - run: 
          command: |
            circleci --version [flag]
----

=== Tests

Collect and split tests so they may be run in parallel.

==== Split

A subcommand of `Tests`. Split Group tests into independent buckets so they can be run in parallel.

*Flags*

[cols="2,3"]
|===
| Flag | Description

| `index`
| Index of node.

| `total`
| Number of nodes.

| `split-by`
| How to weight the split, allowed values are `name`, `filesize`, and `timings`.

| `timings-type`
| Lookup historical timing data by: `classname`, `filename`, `testname` or `autodetect`(automatically choose `classname` or `filename`) (default `autodetect`).

| `show-counts`
| Print test file or test class counts to stderr (default `false`).

| `time-default`
| Override default time value of test timing data when timing is not found (default 0s).

| `timings-file`
| JSON file containing historical timing data.
|===

==== Glob

A subcommand of `Tests`. Glob Print files matching the glob pattern.

*Flags*

NOTE: The available flag for the `glob` subcommand is a pattern, and supports the
following symbols:

[cols="2,3"]
|===
| Symbol | Description

| `*`
| Matches any sequence of non-path-separators.

| `**`
| Matches any sequence of characters, including path separators.

| `?`
| Matches any single non-path-separator character.

| `[...]`
| Matches any character in the set. May use '-' for a range.

| `{...}`
| Matches a sequence of characters, if any of the alternatives in braces matches.
|===

==== Run

A subcommand of `Tests`. The run command splits and run tests.

*Flags*

[cols="2,3"]
|===
| Flag | Description

| `command`
| Script that will be run for a list of tests.

| `index`
| Index of node.

| `total`
| Number of nodes.

| `split-by`
| How to weight the split, allowed values are `name`, `filesize`, and `timings`.

| `timings-type`
| Lookup historical timing data by: `classname`, `filename`, `testname` or `autodetect`(automatically choose classname or filename) (default `autodetect`).

| `show-counts`
| Print test file or test class counts to stderr (default `false`).
|===

*Example usage:*

[source,yaml]
----
version: 2.1

jobs:
  my-job:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          command: |
            ## example usage of split
            circleci tests split [flags] [FILENAME]
            ## example usage of glob
            circleci tests glob [flags] PATTERN
            ## example usage of run
            circleci tests run [flags]
----

*More information on using the `tests` command*:

* xref:optimize:parallelism-faster-jobs.adoc#how-test-splitting-works[Guide to Test splitting and parallelism]
* xref:optimize:use-the-circleci-cli-to-split-tests.adoc[Use the CircleCI CLI to split tests]

=== Environment variables

Use `env` to manage environment variables

==== Subst

This is a subcommnd for `env`. It is used to substitute environment variables in a string

*Example usage:*

Say within your repository there exists a file called template.json, with values replaced by environment variable strings

---
{
  "foo": "$FOO",
  "provider": "${PROVIDER}"
}
---

The config example below shows the corresponding environment variables as if they were defined directly within a step in the config.

[source,yaml]
----
version: 2.1
jobs:
  process-template:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: Process template file
          environment:
            FOO: bar
            PROVIDER: circleci
          command: |
            ## circleci env subst [flags]
            circleci env subst < template.json > deploy.json
            cat deploy.json
workflows:
  env-subst-workflow:
    jobs:
      - process-template
----

In this example, the `<` symbol is used to redirect the contents of the `template.json` file as input to the env subst command, while the `>` symbol is used to redirect the output of the `env subst` command to the `deploy.json`.

You could alternatively pass input to the `circleci env subst` command as an argument: `circleci env subst "hello \$WORLD"`

Output:
---
{
  "foo": "bar",
  "provider": "circleci"
}
---

=== Run

Invokes a task-agent subcommand by name.

==== OIDC

A subcommand of `Run`. This command Run authentication using OIDC.

==== Release

A subcommand of `Run`. This command allows you to manage deployments

===== Plan

A subcommand of `Release`. The `plan` command is used to plan and identify a new deployment that can be referenced to update its status later.

A _planned_ deployment will show in the Deploys UI with `pending` status.

*Flags*

[cols="2,3"]
|===
| Flag | Description

| `deploy-name`
| An arbitrary positional argument that will be used to identify the deployment. This should be unique within the workflow.

| `environment-name`
| Sets the target environment. If the specified environment does not exist, it will be created. If you do not specify an environment, CircleCI will create one named default.

| `component-name`
| Sets the name that will be displayed in the UI. If you do not already have a component in your project a new one will be created with the name of the project. This will be set as the component that is being deployed.

| `target-version`
| Should match the version being deployed.

| `namespace`
| Optional flag to use a namespace value other than default.
|===

===== Update

A subcommand of `Release`. The `update` command is used to update the status of the deployment.

*Flags*

[cols="2,3"]
|===
| Flag | Description

| `status`
| Update the deploy status (values can be `RUNNING`, `SUCCESS`, or `FAILED`).
|===

===== Log

A subcommand of `Release`. The `log` command allows you to log your deployments without status updates

*Flags*

| `environment-name`
| Sets the target environment. If the specified environment does not exist, it will be created. If you do not specify an environment, CircleCI will create one named default.

| `component-name`
| Sets the name that will be displayed in the UI. If you do not already have a component in your project a new one will be created with the name of the project. This will be set as the component that is being deployed.

| `target-version`
| Should match the version being deployed.

| `namespace`
| Optional flag to use a namespace value other than default.
|===

*Example usage:*

#Need to show the example usage of the log subcommand and show them all in a job - full config#

[source,yaml]
----
jobs:
  deploy-my-service:
    executor: some-executor
    steps:
      - run: 
          command: |
            ## example usage of run release plan
            circleci run release plan <deploy-name> --environment-name=<some-environment-name> --component-name=<some-component-name> --target-version=<some-version-name> --namespace=<some-namespace>
            ## example usage of run release update
            circleci run release update <deploy-name> --status=running
            ## example usage of run release log
            circleci run release log --environment-name=<some-environment-name> --component-name=<some-component-name> --target-version=<some-version-name>
----

*More information on using  the `run` command*:

* xref:deploy:configure-deploy-markers.adoc#deploy-markers-with-status-updates[Configure deploy markers]

== Global flags

[cols="2,3"]
|===
| Flag | Description

| `verbose`
| Enable verbose logging output.
|===

== Help

Use the following for more information about a command.

[source]
----
circleci run [command] --help
----